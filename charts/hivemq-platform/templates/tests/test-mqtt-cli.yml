{{- if .Values.testing.enabled }}
{{- range $service := .Values.services }}
{{- if and (eq $service.type "mqtt") $service.exposed }}
{{- $serviceName := include "hivemq-platform.range-service-name" (dict "name" $service.name "releaseName" $.Release.Name "type" $service.type "port" $service.port "containerPort" $service.containerPort "legacyPortName" $service.legacyPortName) }}
---
apiVersion: v1
kind: Pod
metadata:
  name: "hivemq-test-connection-{{$.Release.Name}}-{{ $serviceName }}"
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: hivemq-mqtt-cli
      image: hivemq/mqtt-cli:4.48.0
      args: [ "test",
              "-h",
              "{{ $serviceName }}" ]
  restartPolicy: Never
{{- end }}
{{- end }}
{{- end }}
