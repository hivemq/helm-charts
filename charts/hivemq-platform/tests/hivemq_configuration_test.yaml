suite: test HiveMQ Platform configmap
templates:
  - hivemq-configuration.yml
  - hivemq-custom-resource.yml
release:
  name: platform-release
tests:

  - it: with default platform values
    template: hivemq-configuration.yml
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
            </hivemq>

  - it: with default platform values and all default hivemqRestrictions config values
    template: hivemq-configuration.yml
    set:
      hivemqRestrictions:
        maxConnections: -1
        incomingBandwidthThrottling: 0
        noConnectIdleTimeout: 10000
        maxClientIdLength: 65535
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
              <restrictions>
                <max-connections>-1</max-connections>
                <incoming-bandwidth-throttling>0</incoming-bandwidth-throttling>
                <no-connect-idle-timeout>10000</no-connect-idle-timeout>
                <max-client-id-length>65535</max-client-id-length>
              </restrictions>
            </hivemq>

  - it: with default platform values and some default hivemqRestrictions config values
    template: hivemq-configuration.yml
    set:
      hivemqRestrictions:
        incomingBandwidthThrottling: 0
        maxClientIdLength: 65535
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
              <restrictions>
                <incoming-bandwidth-throttling>0</incoming-bandwidth-throttling>
                <max-client-id-length>65535</max-client-id-length>
              </restrictions>
            </hivemq>

  - it: with default platform values and empty hivemqRestrictions config values
    template: hivemq-configuration.yml
    set:
      hivemqRestrictions: {}
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
            </hivemq>

  - it: with default platform values and all default hivemqMqtt config values
    template: hivemq-configuration.yml
    set:
      hivemqMqtt:
        sessionExpiryMaxInterval: 4294967295
        messageExpiryMaxInterval: 4294967296
        maxPacketSize: 268435460
        serverReceiveMaximum: 10
        keepAliveMax: 65535
        keepAliveAllowUnlimited: true
        topicAliasEnabled: true
        topicAliasMaxPerClient: 5
        subscriptionIdentifier: true
        wildcardSubscriptions: true
        sharedSubscriptions: true
        maxQualityOfService: 2
        retainedMessages: true
        queuedMessagesMaxSize: 1000
        queuedMessagesStrategy: "discard"
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
              <mqtt>
                <session-expiry>
                  <max-interval>4294967295</max-interval>
                </session-expiry>
                <message-expiry>
                  <max-interval>4294967296</max-interval>
                </message-expiry>
                <packets>
                  <max-packet-size>268435460</max-packet-size>
                </packets>
                <receive-maximum>
                  <server-receive-maximum>10</server-receive-maximum>
                </receive-maximum>
                <keep-alive>
                  <max-keep-alive>65535</max-keep-alive>
                  <allow-unlimited>true</allow-unlimited>
                </keep-alive>
                <topic-alias>
                  <enabled>true</enabled>
                  <max-per-client>5</max-per-client>
                </topic-alias>
                <subscription-identifier>
                  <enabled>true</enabled>
                </subscription-identifier>
                <wildcard-subscriptions>
                  <enabled>true</enabled>
                </wildcard-subscriptions>
                <shared-subscriptions>
                  <enabled>true</enabled>
                </shared-subscriptions>
                <quality-of-service>
                  <max-qos>2</max-qos>
                </quality-of-service>
                <retained-messages>
                  <enabled>true</enabled>
                </retained-messages>
                <queued-messages>
                  <max-queue-size>1000</max-queue-size>
                  <strategy>discard</strategy>
                </queued-messages>
              </mqtt>
            </hivemq>

  - it: with default platform values and some default hivemqMqtt config values
    template: hivemq-configuration.yml
    set:
      hivemqMqtt:
        sessionExpiryMaxInterval: 4294967295
        maxPacketSize: 268435460
        keepAliveMax: 65535
        topicAliasEnabled: true
        subscriptionIdentifier: true
        sharedSubscriptions: true
        retainedMessages: true
        queuedMessagesStrategy: "discard"
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
              <mqtt>
                <session-expiry>
                  <max-interval>4294967295</max-interval>
                </session-expiry>
                <packets>
                  <max-packet-size>268435460</max-packet-size>
                </packets>
                <keep-alive>
                  <max-keep-alive>65535</max-keep-alive>
                </keep-alive>
                <topic-alias>
                  <enabled>true</enabled>
                </topic-alias>
                <subscription-identifier>
                  <enabled>true</enabled>
                </subscription-identifier>
                <shared-subscriptions>
                  <enabled>true</enabled>
                </shared-subscriptions>
                <retained-messages>
                  <enabled>true</enabled>
                </retained-messages>
                <queued-messages>
                  <strategy>discard</strategy>
                </queued-messages>
              </mqtt>
            </hivemq>

  - it: with default platform values and empty hivemqMqtt config values
    template: hivemq-configuration.yml
    set:
      hivemqMqtt: {}
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
            </hivemq>

  - it: with default platform values and all default hivemqMqttAddons config values
    template: hivemq-configuration.yml
    set:
      hivemqMqttAddons:
        expiredMessagesTopic: false
        droppedMessagesTopic: false
        deadMessagesTopic: false
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
              <mqtt-addons>
                <expired-messages-topic>
                  <enabled>false</enabled>
                </expired-messages-topic>
                <dropped-messages-topic>
                  <enabled>false</enabled>
                </dropped-messages-topic>
                <dead-messages-topic>
                  <enabled>false</enabled>
                </dead-messages-topic>
              </mqtt-addons>
            </hivemq>

  - it: with default platform values and some default hivemqMqttAddons config values
    template: hivemq-configuration.yml
    set:
      hivemqMqttAddons:
        droppedMessagesTopic: false
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
              <mqtt-addons>
                <dropped-messages-topic>
                  <enabled>false</enabled>
                </dropped-messages-topic>
              </mqtt-addons>
            </hivemq>

  - it: with default platform values and empty hivemqMqttAddons config values
    template: hivemq-configuration.yml
    set:
      hivemqMqttAddons: {}
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
            </hivemq>

  - it: with default platform values and all default hivemqMqttSecurity config values
    template: hivemq-configuration.yml
    set:
      hivemqMqttSecurity:
        allowEmptyClientId: true
        payloadFormatValidation: false
        utf8Validation: true
        allowRequestProblemInformation: true
        controlCenterAuditLog: true
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
              <security>
                <allow-empty-client-id>
                  <enabled>true</enabled>
                </allow-empty-client-id>
                <payload-format-validation>
                  <enabled>false</enabled>
                </payload-format-validation>
                <utf8-validation>
                  <enabled>true</enabled>
                </utf8-validation>
                <allow-request-problem-information>
                  <enabled>true</enabled>
                </allow-request-problem-information>
                <control-center-audit-log>
                  <enabled>true</enabled>
                </control-center-audit-log>
              </security>
            </hivemq>

  - it: with default platform values and some default hivemqMqttSecurity config values
    template: hivemq-configuration.yml
    set:
      hivemqMqttSecurity:
        allowEmptyClientId: true
        utf8Validation: true
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
              <security>
                <allow-empty-client-id>
                  <enabled>true</enabled>
                </allow-empty-client-id>
                <utf8-validation>
                  <enabled>true</enabled>
                </utf8-validation>
              </security>
            </hivemq>

  - it: with default platform values and empty hivemqMqttSecurity config values
    template: hivemq-configuration.yml
    set:
      hivemqMqttSecurity: {}
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
            </hivemq>

  - it: with default platform values and all HiveMQ configuration options set
    template: hivemq-configuration.yml
    set:
      hivemqRestrictions:
        maxConnections: -1
        incomingBandwidthThrottling: 0
        noConnectIdleTimeout: 10000
        maxClientIdLength: 65535
      hivemqMqtt:
        sessionExpiryMaxInterval: 4294967295
        messageExpiryMaxInterval: 4294967296
        maxPacketSize: 268435460
        serverReceiveMaximum: 10
        keepAliveMax: 65535
        keepAliveAllowUnlimited: true
        topicAliasEnabled: true
        topicAliasMaxPerClient: 5
        subscriptionIdentifier: true
        wildcardSubscriptions: true
        sharedSubscriptions: true
        maxQualityOfService: 2
        retainedMessages: true
        queuedMessagesMaxSize: 1000
        queuedMessagesStrategy: "discard"
      hivemqMqttAddons:
        expiredMessagesTopic: false
        droppedMessagesTopic: false
        deadMessagesTopic: false
      hivemqMqttSecurity:
        allowEmptyClientId: true
        payloadFormatValidation: false
        utf8Validation: true
        allowRequestProblemInformation: true
        controlCenterAuditLog: true
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </control-center>
              <restrictions>
                <max-connections>-1</max-connections>
                <incoming-bandwidth-throttling>0</incoming-bandwidth-throttling>
                <no-connect-idle-timeout>10000</no-connect-idle-timeout>
                <max-client-id-length>65535</max-client-id-length>
              </restrictions>
              <mqtt>
                <session-expiry>
                  <max-interval>4294967295</max-interval>
                </session-expiry>
                <message-expiry>
                  <max-interval>4294967296</max-interval>
                </message-expiry>
                <packets>
                  <max-packet-size>268435460</max-packet-size>
                </packets>
                <receive-maximum>
                  <server-receive-maximum>10</server-receive-maximum>
                </receive-maximum>
                <keep-alive>
                  <max-keep-alive>65535</max-keep-alive>
                  <allow-unlimited>true</allow-unlimited>
                </keep-alive>
                <topic-alias>
                  <enabled>true</enabled>
                  <max-per-client>5</max-per-client>
                </topic-alias>
                <subscription-identifier>
                  <enabled>true</enabled>
                </subscription-identifier>
                <wildcard-subscriptions>
                  <enabled>true</enabled>
                </wildcard-subscriptions>
                <shared-subscriptions>
                  <enabled>true</enabled>
                </shared-subscriptions>
                <quality-of-service>
                  <max-qos>2</max-qos>
                </quality-of-service>
                <retained-messages>
                  <enabled>true</enabled>
                </retained-messages>
                <queued-messages>
                  <max-queue-size>1000</max-queue-size>
                  <strategy>discard</strategy>
                </queued-messages>
              </mqtt>
              <mqtt-addons>
                <expired-messages-topic>
                  <enabled>false</enabled>
                </expired-messages-topic>
                <dropped-messages-topic>
                  <enabled>false</enabled>
                </dropped-messages-topic>
                <dead-messages-topic>
                  <enabled>false</enabled>
                </dead-messages-topic>
              </mqtt-addons>
              <security>
                <allow-empty-client-id>
                  <enabled>true</enabled>
                </allow-empty-client-id>
                <payload-format-validation>
                  <enabled>false</enabled>
                </payload-format-validation>
                <utf8-validation>
                  <enabled>true</enabled>
                </utf8-validation>
                <allow-request-problem-information>
                  <enabled>true</enabled>
                </allow-request-problem-information>
                <control-center-audit-log>
                  <enabled>true</enabled>
                </control-center-audit-log>
              </security>
            </hivemq>

  - it: with create config true
    template: hivemq-configuration.yml
    set:
      config.create: true
      config.overrideContent: "content"
    asserts:
      - exists:
          path: data
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: hivemq-configuration-platform-release
      - equal:
          path: spec.configMapName
          value: hivemq-configuration-platform-release
        template: hivemq-custom-resource.yml

  - it: with existing configMap, but name not set, then fails
    template: hivemq-custom-resource.yml
    set:
      config.create: false
    asserts:
      - failedTemplate:
          errorMessage: HiveMQ configuration ConfigMap name cannot be empty when using an existing ConfigMap

  - it: with a MQTT service exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: mqtt
          exposed: true
          containerPort: 1884
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<tcp-listener>.*?<port>1884</port>.*?</tcp-listener>"
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<tls-tcp-listener>.*?<port>1884</port>.*?</tls-tcp-listener>"

  - it: with a MQTT service not exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: mqtt
          exposed: false
          containerPort: 1884
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<tcp-listener>.*?<port>1884</port>.*?</tcp-listener>"
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<tls-tcp-listener>.*?<port>1884</port>.*?</tls-tcp-listener>"

  - it: with a secure MQTT service exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: mqtt
          exposed: true
          containerPort: 1884
          keystoreSecretName: "mqtt-secret"
          keystoreSecretKey: "keystore.jks"
          keystorePassword: "a2V5LWNoYW5nZW1lCg==" # key-changeme
          tlsClientAuthenticationMode: "OPTIONAL"
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tls-tcp-listener>
                  <port>1884</port>
                  <bind-address>0.0.0.0</bind-address>
                  <tls>
                    <keystore>
                      <path>/tls-mqtt-secret/keystore.jks</path>
                      <password>${mqtt_platform-release_mqtt-secret_keystore_pass}</password>
                      <private-key-password>${mqtt_platform-release_mqtt-secret_keystore_pass}</private-key-password>
                    </keystore>
                    <client-authentication-mode>OPTIONAL</client-authentication-mode>
                  </tls>
                </tls-tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
            </hivemq>
      - exists:
          path: spec.statefulSet.spec.template.spec.containers[0].env
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].env
          content:
            name: mqtt_platform-release_mqtt-secret_keystore_pass
            value: key-changeme
        template: hivemq-custom-resource.yml
      - notContains:
          path: spec.statefulSet.spec.template.spec.containers[0].env
          content:
            name: mqtt_platform-release_truststore-secret_truststore_pass
            value: trust-changeme
        template: hivemq-custom-resource.yml

  - it: with a secure mutual TLS MQTT service exposed, using keystorePassword and truststorePassword
    template: hivemq-configuration.yml
    set:
      services:
        - type: mqtt
          exposed: true
          containerPort: 1884
          keystoreSecretName: "mqtt-secret"
          keystoreSecretKey: "keystore.jks"
          keystorePassword: "a2V5LWNoYW5nZW1lCg==" # key-changeme
          tlsClientAuthenticationMode: "OPTIONAL"
          truststoreSecretName: "truststore-secret"
          truststoreSecretKey: "truststore.jks"
          truststorePassword: "dHJ1c3QtY2hhbmdlbWUK" # trust-changeme
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tls-tcp-listener>
                  <port>1884</port>
                  <bind-address>0.0.0.0</bind-address>
                  <tls>
                    <keystore>
                      <path>/tls-mqtt-secret/keystore.jks</path>
                      <password>${mqtt_platform-release_mqtt-secret_keystore_pass}</password>
                      <private-key-password>${mqtt_platform-release_mqtt-secret_keystore_pass}</private-key-password>
                    </keystore>
                    <truststore>
                      <path>/tls-truststore-secret/truststore.jks</path>
                      <password>${mqtt_platform-release_truststore-secret_truststore_pass}</password>
                    </truststore>
                    <client-authentication-mode>OPTIONAL</client-authentication-mode>
                  </tls>
                </tls-tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
            </hivemq>
      - exists:
          path: spec.statefulSet.spec.template.spec.containers[0].env
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].env
          content:
            name: mqtt_platform-release_mqtt-secret_keystore_pass
            value: key-changeme
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].env
          content:
            name: mqtt_platform-release_truststore-secret_truststore_pass
            value: trust-changeme
        template: hivemq-custom-resource.yml

  - it: with a secure mutual TLS MQTT service exposed, using keystorePasswordSecretName and truststorePasswordSecretName
    template: hivemq-configuration.yml
    set:
      services:
        - type: mqtt
          exposed: true
          containerPort: 1884
          keystoreSecretName: "mqtt-secret"
          keystoreSecretKey: "keystore.jks"
          keystorePasswordSecretName: "my-keystore-secret"
          tlsClientAuthenticationMode: "OPTIONAL"
          truststoreSecretName: "truststore-secret"
          truststoreSecretKey: "truststore.jks"
          truststorePasswordSecretName: "my-truststore-secret"
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tls-tcp-listener>
                  <port>1884</port>
                  <bind-address>0.0.0.0</bind-address>
                  <tls>
                    <keystore>
                      <path>/tls-mqtt-secret/keystore.jks</path>
                      <password>${mqtt_platform-release_mqtt-secret_keystore_pass}</password>
                      <private-key-password>${mqtt_platform-release_mqtt-secret_keystore_pass}</private-key-password>
                    </keystore>
                    <truststore>
                      <path>/tls-truststore-secret/truststore.jks</path>
                      <password>${mqtt_platform-release_truststore-secret_truststore_pass}</password>
                    </truststore>
                    <client-authentication-mode>OPTIONAL</client-authentication-mode>
                  </tls>
                </tls-tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
            </hivemq>
      - exists:
          path: spec.statefulSet.spec.template.spec.containers[0].env
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].env
          content:
            name: mqtt_platform-release_mqtt-secret_keystore_pass
            valueFrom:
              secretKeyRef:
                key: keystore.password
                name: my-keystore-secret
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].env
          content:
            name: mqtt_platform-release_truststore-secret_truststore_pass
            valueFrom:
              secretKeyRef:
                key: truststore.password
                name: my-truststore-secret
        template: hivemq-custom-resource.yml

  - it: with a secure mutual TLS MQTT service exposed, but missing required keystore password
    template: hivemq-custom-resource.yml
    set:
      services:
        - type: mqtt
          exposed: true
          containerPort: 1884
          keystoreSecretName: "mqtt-secret"
          keystoreSecretKey: "keystore.jks"
          tlsClientAuthenticationMode: "OPTIONAL"
          truststoreSecretName: "truststore-secret"
          truststoreSecretKey: "truststore.jks"
          truststorePasswordSecretName: "my-truststore-secret"
    asserts:
      - failedTemplate:
          errorMessage: A keystore password should be set either as a string (keystorePassword) or as a secret name (keystorePasswordSecretName)

  - it: with a secure mutual TLS MQTT service exposed, but missing required truststore password
    template: hivemq-custom-resource.yml
    set:
      services:
        - type: mqtt
          exposed: true
          containerPort: 1884
          keystoreSecretName: "mqtt-secret"
          keystoreSecretKey: "keystore.jks"
          keystorePasswordSecretName: "my-keystore-secret"
          tlsClientAuthenticationMode: "OPTIONAL"
          truststoreSecretName: "truststore-secret"
          truststoreSecretKey: "truststore.jks"
    asserts:
      - failedTemplate:
          errorMessage: A truststore password should be set either as a string (truststorePassword) or as a secret name (truststorePasswordSecretName)

  - it: with a secure mutual TLS MQTT service not exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: mqtt
          exposed: false
          containerPort: 1884
          keystoreSecretName: "mqtt-secret"
          keystoreSecretKey: "keystore.jks"
          tlsClientAuthenticationMode: "OPTIONAL"
          truststoreSecretName: "truststore-secret"
          truststoreSecretKey: "truststore.jks"
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<tcp-listener>.*?<port>1884</port>.*?</tcp-listener>"
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<tls-tcp-listener>.*?<port>1884</port>.*?</tls-tcp-listener>"

  - it: with a secure mutual TLS MQTT service exposed using default values
    template: hivemq-configuration.yml
    set:
      services:
        - type: mqtt
          exposed: true
          containerPort: 1884
          keystoreSecretName: "mqtt-secret"
          keystorePasswordSecretName: "my-keystore-secret"
          truststoreSecretName: "truststore-secret"
          truststorePasswordSecretName: "my-truststore-secret"
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tls-tcp-listener>
                  <port>1884</port>
                  <bind-address>0.0.0.0</bind-address>
                  <tls>
                    <keystore>
                      <path>/tls-mqtt-secret/keystore</path>
                      <password>${mqtt_platform-release_mqtt-secret_keystore_pass}</password>
                      <private-key-password>${mqtt_platform-release_mqtt-secret_keystore_pass}</private-key-password>
                    </keystore>
                    <truststore>
                      <path>/tls-truststore-secret/truststore</path>
                      <password>${mqtt_platform-release_truststore-secret_truststore_pass}</password>
                    </truststore>
                  </tls>
                </tls-tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
            </hivemq>
      - exists:
          path: spec.statefulSet.spec.template.spec.containers[0].env
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].env
          content:
            name: mqtt_platform-release_mqtt-secret_keystore_pass
            valueFrom:
              secretKeyRef:
                key: keystore.password
                name: my-keystore-secret
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].env
          content:
            name: mqtt_platform-release_truststore-secret_truststore_pass
            valueFrom:
              secretKeyRef:
                key: truststore.password
                name: my-truststore-secret
        template: hivemq-custom-resource.yml

  - it: with a Control Center service exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: control-center
          exposed: true
          containerPort: 8081
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<control-center>.*?<port>8081</port>.*?</control-center>"

  - it: with a Control Center service not exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: control-center
          exposed: false
          containerPort: 8081
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<control-center>.*?<port>8081</port>.*?</control-center>"

  - it: with Control Center user and password
    template: hivemq-configuration.yml
    set:
      controlCenter.username: "test-username"
      controlCenter.password: "c638833f69bbfb3c267afa0a74434812436b8f08a81fd263c6be6871de4f1265"
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <listeners>
                <tcp-listener>
                  <port>1883</port>
                  <bind-address>0.0.0.0</bind-address>
                </tcp-listener>
              </listeners>
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <http>
                    <port>8080</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
                <users>
                  <user>
                    <name>test-username</name>
                    <password>c638833f69bbfb3c267afa0a74434812436b8f08a81fd263c6be6871de4f1265</password>
                  </user>
                </users>
              </control-center>
            </hivemq>

  - it: with default Control Center username and password
    template: hivemq-configuration.yml
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<user>.*?<name>test-username</name>.*?<password>test-password</password>.*?</user>"

  - it: with a secure Control Center service enabled, using keystorePassword
    template: hivemq-configuration.yml
    set:
      services:
        - type: control-center
          exposed: true
          containerPort: 8443
          keystoreSecretName: "control-center-secret"
          keystoreSecretKey: "keystore.jks"
          keystorePassword: "a2V5LWNoYW5nZW1lCg==" # key-changeme
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <https>
                    <port>8443</port>
                    <bind-address>0.0.0.0</bind-address>
                    <tls>
                      <keystore>
                        <path>/tls-control-center-secret/keystore.jks</path>
                        <password>${control-center_platform-release_control-center-secret_keystore_pass}</password>
                        <private-key-password>${control-center_platform-release_control-center-secret_keystore_pass}</private-key-password>
                      </keystore>
                    </tls>
                  </https>
                </listeners>
              </control-center>
            </hivemq>

  - it: with a secure Control Center service enabled, using keystorePasswordSecretName
    template: hivemq-configuration.yml
    set:
      services:
        - type: control-center
          exposed: true
          containerPort: 8443
          keystoreSecretName: "control-center-secret"
          keystoreSecretKey: "keystore.jks"
          keystorePasswordSecretName: "control-center-keystore-password"
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <https>
                    <port>8443</port>
                    <bind-address>0.0.0.0</bind-address>
                    <tls>
                      <keystore>
                        <path>/tls-control-center-secret/keystore.jks</path>
                        <password>${control-center_platform-release_control-center-secret_keystore_pass}</password>
                        <private-key-password>${control-center_platform-release_control-center-secret_keystore_pass}</private-key-password>
                      </keystore>
                    </tls>
                  </https>
                </listeners>
              </control-center>
            </hivemq>

  - it: with a secure Control Center service disabled, no secure Control Service is exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: control-center
          exposed: false
          containerPort: 8443
          keystoreSecretName: "control-center-secret"
          keystoreSecretKey: "keystore.jks"
          keystorePasswordSecretName: "control-center-keystore-password"
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<control-center>.*?<listeners>.*?<https>.*?<port>8443</port>.*?</https>.*?<listeners>.*?</control-center>"

  - it: with several secure and non-secure Control Center services enabled and reusing keystores
    template: hivemq-configuration.yml
    values:
      - tls-cc-services-values.yaml
    asserts:
      - exists:
          path: data["config.xml"]
      - equal:
          path: data["config.xml"]
          value: |-
            <?xml version="1.0"?>
            <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
              <cluster>
                <transport>
                  <tcp>
                    <bind-address>0.0.0.0</bind-address>
                    <bind-port>7000</bind-port>
                  </tcp>
                </transport>
                <enabled>true</enabled>
                <discovery>
                  <extension/>
                </discovery>
              </cluster>
              <!-- required and should not be configured different -->
              <health-api>
                <enabled>true</enabled>
                <listeners>
                  <http>
                    <port>8889</port>
                    <bind-address>0.0.0.0</bind-address>
                  </http>
                </listeners>
              </health-api>
              <control-center>
                <listeners>
                  <https>
                    <port>8443</port>
                    <bind-address>0.0.0.0</bind-address>
                    <tls>
                      <keystore>
                        <path>/tls-control-center-secret/keystore</path>
                        <password>${control-center_platform-release_control-center-secret_keystore_pass}</password>
                        <private-key-password>${control-center_platform-release_control-center-secret_keystore_pass}</private-key-password>
                      </keystore>
                    </tls>
                  </https>
                  <https>
                    <port>8444</port>
                    <bind-address>0.0.0.0</bind-address>
                    <tls>
                      <keystore>
                        <path>/tls-control-center-secret/keystore</path>
                        <password>${control-center_platform-release_control-center-secret_keystore_pass}</password>
                        <private-key-password>${control-center_platform-release_control-center-secret_keystore_pass}</private-key-password>
                      </keystore>
                    </tls>
                  </https>
                  <https>
                    <port>8445</port>
                    <bind-address>0.0.0.0</bind-address>
                    <tls>
                      <keystore>
                        <path>/tls-control-center-secret1/keystore</path>
                        <password>${control-center_platform-release_control-center-secret1_keystore_pass}</password>
                        <private-key-password>${control-center_platform-release_control-center-secret1_keystore_pass}</private-key-password>
                      </keystore>
                    </tls>
                  </https>
                </listeners>
              </control-center>
            </hivemq>

  - it: with a Rest API service exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: rest-api
          exposed: true
          containerPort: 8890
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<rest-api>.*?<enabled>true</enabled>.*?</rest-api>"
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<rest-api>.*?<port>8890</port>.*?</rest-api>"

  - it: with a Rest API service not being exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: rest-api
          exposed: false
          containerPort: 8890
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<rest-api>.*?<enabled>true</enabled>.*?</rest-api>"
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<rest-api>.*?<port>8890</port>.*?</rest-api>"

  - it: with REST API authentication enabled
    template: hivemq-configuration.yml
    set:
      restApi.authEnabled: true
      services:
        - type: rest-api
          exposed: true
          containerPort: 8890
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<rest-api>.*?<enabled>true</enabled>.*?</rest-api>"
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<rest-api>.*?<auth>.*?<enabled>true</enabled>.*?</auth>.*?</rest-api>"
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<rest-api>.*?<port>8890</port>.*?</rest-api>"

  - it: with default REST API authentication
    template: hivemq-configuration.yml
    set:
      services:
        - type: rest-api
          exposed: true
          containerPort: 8890
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<rest-api>.*?<enabled>true</enabled>.*?</rest-api>"
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<rest-api>.*?<auth>.*?<enabled>false</enabled>.*?</auth>.*?</rest-api>"

  - it: with a WebSocket service exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: websocket
          exposed: true
          containerPort: 8000
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<websocket-listener>.*?<port>8000</port>.*?</websocket-listener>"
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<tls-websocket-listener>.*?<port>8000</port>.*?</tls-websocket-listener>"

  - it: with a WebSocket service not exposed
    template: hivemq-configuration.yml
    set:
      services:
        - type: websocket
          exposed: false
          containerPort: 8000
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<websocket-listener>.*?<port>8000</port>.*?</websocket-listener>"
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<tls-websocket-listener>.*?<port>8000</port>.*?</tls-websocket-listener>"

  - it: with Data Hub enabled
    template: hivemq-configuration.yml
    set:
      config.dataHub.dataValidationEnabled: true
      config.dataHub.behaviorValidationEnabled: true
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>true</enabled>.*?</data-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>true</enabled>.*?</behavior-validation>.*?</data-hub>"

  - it: with Data Hub disabled
    template: hivemq-configuration.yml
    set:
      config.dataHub.dataValidationEnabled: false
      config.dataHub.behaviorValidationEnabled: false
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<data-hub>.*?</data-hub>"

  - it: with Data Hub - Data validation enabled only
    template: hivemq-configuration.yml
    set:
      config.dataHub.dataValidationEnabled: true
      config.dataHub.behaviorValidationEnabled: false
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>true</enabled>.*?</data-validation>.*?</data-hub>"
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>true</enabled>.*?</behavior-validation>.*?</data-hub>"

  - it: with Data Hub - Behavior validation enabled only
    template: hivemq-configuration.yml
    set:
      config.dataHub.dataValidationEnabled: false
      config.dataHub.behaviorValidationEnabled: true
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>true</enabled>.*?</data-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>true</enabled>.*?</behavior-validation>.*?</data-hub>"

  - it: with Data Hub default
    template: hivemq-configuration.yml
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>true</enabled>.*?</data-validation>.*?<behavior-validation>.*?<enabled>true</enabled>.*?</behavior-validation>.*?</data-hub>"
