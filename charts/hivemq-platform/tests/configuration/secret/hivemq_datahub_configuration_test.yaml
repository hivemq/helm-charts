suite: HiveMQ Platform Configuration as Secret - Data Hub tests
templates:
  - hivemq-configuration.yml
release:
  name: test-hivemq-platform
  namespace: test-hivemq-platform-namespace
chart:
  version: 0.0.1
  appVersion: 1.0.0
set:
  config.createAs: Secret
asserts:
  - containsDocument:
    apiVersion: v1
    kind: Secret
    name: hivemq-configuration-test-hivemq-platform
    namespace: test-hivemq-platform-namespace
    template: hivemq-configuration.yml
tests:

  - it: with Data Hub default
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?</data-hub>"

  - it: with Data Hub features disabled
    set:
      config.dataHub.dataValidationEnabled: false
      config.dataHub.behaviorValidationEnabled: false
      config.dataHub.scripting: false
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?</data-hub>"

  - it: with Data Hub features enabled
    set:
      config.dataHub.dataValidationEnabled: true
      config.dataHub.behaviorValidationEnabled: true
      config.dataHub.scripting: true
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>true</enabled>.*?</data-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>true</enabled>.*?</behavior-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?<enabled>true</enabled>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - Data validation enabled only
    set:
      config.dataHub.dataValidationEnabled: true
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>true</enabled>.*?</data-validation>.*?</data-hub>"
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?</behavior-validation>.*?</data-hub>"
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - Data validation enabled, rest disabled
    set:
      config.dataHub.dataValidationEnabled: true
      config.dataHub.behaviorValidationEnabled: false
      config.dataHub.scripting: false
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>true</enabled>.*?</data-validation>.*?</data-hub>"
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?</behavior-validation>.*?</data-hub>"
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - Behavior validation enabled only
    set:
      config.dataHub.behaviorValidationEnabled: true
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?</data-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>true</enabled>.*?</behavior-validation>.*?</data-hub>"
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - Behavior validation enabled, rest disabled
    set:
      config.dataHub.dataValidationEnabled: false
      config.dataHub.behaviorValidationEnabled: true
      config.dataHub.scripting: false
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?</data-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>true</enabled>.*?</behavior-validation>.*?</data-hub>"
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - Scripting enabled only
    set:
      config.dataHub.scripting: true
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?</data-validation>.*?</data-hub>"
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?</behavior-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?<enabled>true</enabled>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - Scripting enabled, rest disabled
    set:
      config.dataHub.dataValidationEnabled: false
      config.dataHub.behaviorValidationEnabled: false
      config.dataHub.scripting: true
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?</data-validation>.*?</data-hub>"
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?</behavior-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?<enabled>true</enabled>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - includeDisabled true, all features disabled
    set:
      config.dataHub.includeDisabled: true
      config.dataHub.dataValidationEnabled: false
      config.dataHub.behaviorValidationEnabled: false
      config.dataHub.scripting: false
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>false</enabled>.*?</data-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>false</enabled>.*?</behavior-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?<enabled>false</enabled>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - includeDisabled true, dataValidation enabled
    set:
      config.dataHub.includeDisabled: true
      config.dataHub.dataValidationEnabled: true
      config.dataHub.behaviorValidationEnabled: false
      config.dataHub.scripting: false
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>true</enabled>.*?</data-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>false</enabled>.*?</behavior-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?<enabled>false</enabled>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - includeDisabled true, behaviorValidation enabled
    set:
      config.dataHub.includeDisabled: true
      config.dataHub.dataValidationEnabled: false
      config.dataHub.behaviorValidationEnabled: true
      config.dataHub.scripting: false
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>false</enabled>.*?</data-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>true</enabled>.*?</behavior-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?<enabled>false</enabled>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - includeDisabled true, scripting enabled
    set:
      config.dataHub.includeDisabled: true
      config.dataHub.dataValidationEnabled: false
      config.dataHub.behaviorValidationEnabled: false
      config.dataHub.scripting: true
    asserts:
      - exists:
          path: data["config.xml"]
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<data-validation>.*?<enabled>false</enabled>.*?</data-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<behavior-validation>.*?<enabled>false</enabled>.*?</behavior-validation>.*?</data-hub>"
      - matchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?<scripting>.*?<enabled>true</enabled>.*?</scripting>.*?</data-hub>"

  - it: with Data Hub - includeDisabled false, all features skipped
    set:
      config.dataHub.includeDisabled: false
      config.dataHub.dataValidationEnabled: false
      config.dataHub.behaviorValidationEnabled: false
      config.dataHub.scripting: false
    asserts:
      - exists:
          path: data["config.xml"]
      - notMatchRegex:
          path: data["config.xml"]
          decodeBase64: true
          pattern: "(?s)<data-hub>.*?</data-hub>"

  - it: with invalid Data validation, schema validation fails
    set:
      config.dataHub.dataValidationEnabled: invalid-value
    asserts:
      - failedTemplate: {}

  - it: with invalid Behavior validation, schema validation fails
    set:
      config.dataHub.behaviorValidationEnabled: invalid-value
    asserts:
      - failedTemplate: {}

  - it: with invalid Scripting, schema validation fails
    set:
      config.dataHub.scripting: invalid-value
    asserts:
      - failedTemplate: {}

  - it: with invalid includeDisabled, schema validation fails
    set:
      config.dataHub.includeDisabled: invalid-value
    asserts:
      - failedTemplate: {}
