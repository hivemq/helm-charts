suite: HiveMQ Platform - HiveMQ Pulse configuration tests
templates:
  - hivemq-pulse-configuration.yml
  - hivemq-custom-resource.yml
release:
  name: test-platform
tests:

  - it: should not create a Pulse configuration Secret by default
    asserts:
      - hasDocuments:
          count: 0
        template: hivemq-pulse-configuration.yml
      - notContains:
          path: spec.statefulSet.spec.template.spec.containers[0].volumeMounts
          content:
            name: pulse-config
        template: hivemq-custom-resource.yml
      - notContains:
          path: spec.statefulSet.spec.template.spec.volumes
          content:
            name: pulse-config
        template: hivemq-custom-resource.yml

  - it: should create a Pulse configuration Secret when `create` is true with `data`
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
    asserts:
      - hasDocuments:
          count: 1
        template: hivemq-pulse-configuration.yml
      - containsDocument:
          apiVersion: v1
          kind: Secret
          name: hivemq-pulse-configuration-test-platform
        template: hivemq-pulse-configuration.yml
      - equal:
          path: data["config.xml"]
          value: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
        template: hivemq-pulse-configuration.yml
      - exists:
          path: spec.statefulSet.spec.template.spec.containers[0].env
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].volumeMounts
          count: 1
          content:
            name: pulse-config
            mountPath: /opt/hivemq/pulse/conf
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.volumes
          count: 1
          content:
            name: pulse-config
            secret:
              secretName: hivemq-pulse-configuration-test-platform
        template: hivemq-custom-resource.yml

  - it: should create a Pulse configuration Secret with custom name
    set:
      pulse:
        create: true
        name: "custom-pulse-config"
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
    asserts:
      - equal:
          path: metadata.name
          value: custom-pulse-config
        template: hivemq-pulse-configuration.yml
      - equal:
          path: data["config.xml"]
          value: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
        template: hivemq-pulse-configuration.yml
      - exists:
          path: spec.statefulSet.spec.template.spec.containers[0].env
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].volumeMounts
          count: 1
          content:
            name: pulse-config
            mountPath: /opt/hivemq/pulse/conf
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.volumes
          count: 1
          content:
            name: pulse-config
            secret:
              secretName: custom-pulse-config
        template: hivemq-custom-resource.yml

  - it: should reuse an existing custom Pulse configuration Secret
    set:
      pulse:
        create: false
        name: "custom-pulse-config"
    asserts:
      - hasDocuments:
          count: 0
        template: hivemq-pulse-configuration.yml
      - exists:
          path: spec.statefulSet.spec.template.spec.containers[0].env
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.containers[0].volumeMounts
          count: 1
          content:
            name: pulse-config
            mountPath: /opt/hivemq/pulse/conf
        template: hivemq-custom-resource.yml
      - contains:
          path: spec.statefulSet.spec.template.spec.volumes
          count: 1
          content:
            name: pulse-config
            secret:
              secretName: custom-pulse-config
        template: hivemq-custom-resource.yml

  - it: should create a Pulse configuration Secret with annotations
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
        annotations:
          annotation1: value1
          annotation2: value2
    template: hivemq-pulse-configuration.yml
    asserts:
      - equal:
          path: metadata.annotations.annotation1
          value: value1
      - equal:
          path: metadata.annotations.annotation2
          value: value2

  - it: should create a Pulse configuration Secret with labels
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
        labels:
          label1: value1
          label2: value2
    template: hivemq-pulse-configuration.yml
    asserts:
      - equal:
          path: metadata.labels.label1
          value: value1
      - equal:
          path: metadata.labels.label2
          value: value2

  - it: should create a Pulse configuration Secret with `overridePulseConfig` when `isPulseConfigBase64Encoded` is false
    set:
      pulse:
        create: true
        isPulseConfigBase64Encoded: false
        overridePulseConfig: |
          <pulse>
            <enabled>true</enabled>
          </pulse>
    template: hivemq-pulse-configuration.yml
    asserts:
      - equal:
          path: stringData["config.xml"]
          value: |-
            <pulse>
              <enabled>true</enabled>
            </pulse>

  - it: should create a Pulse configuration Secret with `overridePulseConfig` when `isPulseConfigBase64Encoded` is true
    set:
      pulse:
        create: true
        isPulseConfigBase64Encoded: true
        overridePulseConfig: |
          <pulse>
            <enabled>true</enabled>
          </pulse>
    template: hivemq-pulse-configuration.yml
    asserts:
      - equal:
          path: data["config.xml"]
          decodeBase64: true
          value: |
            <pulse>
              <enabled>true</enabled>
            </pulse>

  - it: should create a Pulse configuration Secret with stringData when `isPulseConfigBase64Encoded` is false
    set:
      pulse:
        create: true
        isPulseConfigBase64Encoded: false
        data: "<pulse><enabled>true</enabled></pulse>"
    template: hivemq-pulse-configuration.yml
    asserts:
      - equal:
          path: stringData["config.xml"]
          value: "<pulse><enabled>true</enabled></pulse>"

  - it: should fail validation when HIVEMQ_PULSE_FOLDER env var is defined
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
      nodes:
        env:
          - name: HIVEMQ_PULSE_FOLDER
            value: /some/other/path
    template: hivemq-custom-resource.yml
    asserts:
      - failedTemplate:
          errorMessage: "HIVEMQ_PULSE_FOLDER environment variable cannot be set"

  - it: should not fail validation when HIVEMQ_PULSE_FOLDER env var is defined but no Pulse is configured
    set:
      nodes:
        env:
          - name: HIVEMQ_PULSE_FOLDER
            value: /some/other/path
    template: hivemq-custom-resource.yml
    asserts:
      - notFailedTemplate: {}
      - hasDocuments:
          count: 1

  - it: should fail validation when additional volume mount path clashes with default Pulse configuration mount path
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
      additionalVolumes:
        - name: conflicting-pulse-secret
          type: secret
          path: /opt/hivemq/pulse/conf
    template: hivemq-custom-resource.yml
    asserts:
      - failedTemplate:
          errorMessage: "VolumeMount path `/opt/hivemq/pulse/conf` (path: `/opt/hivemq/pulse/conf` value, subPath: `` value) is duplicated for container `hivemq`"

  - it: should fail validation when additional volume mount path clashes with default Pulse configuration mount path using an existing custom Pulse configuration Secret
    set:
      pulse:
        name: "my-custom-pulse-config"
      additionalVolumes:
        - name: conflicting-pulse-secret
          type: secret
          path: /opt/hivemq/pulse/conf
    template: hivemq-custom-resource.yml
    asserts:
      - failedTemplate:
          errorMessage: "VolumeMount path `/opt/hivemq/pulse/conf` (path: `/opt/hivemq/pulse/conf` value, subPath: `` value) is duplicated for container `hivemq`"

  - it: should pass validation when additional volume mount path clashes with default Pulse configuration mount path but in different container
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
      additionalVolumes:
        - name: conflicting-pulse-secret
          type: secret
          containerName: foobar
          path: /opt/hivemq/pulse/conf
    template: hivemq-custom-resource.yml
    asserts:
      - notFailedTemplate: {}
      - hasDocuments:
          count: 1

  - it: should fail validation when additional volume name clashes with default Pulse configuration volume name
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
      additionalVolumes:
        - name: pulse-config
          type: secret
          path: /some/other/pulse/config/path
    template: hivemq-custom-resource.yml
    asserts:
      - failedTemplate:
          errorMessage: "VolumeMount `pulse-config` (name: `pulse-config` value, mountName: `` value) is duplicated for container `hivemq`"

  - it: should fail validation when additional volume name clashes with existing custom Pulse configuration Secret
    set:
      pulse:
        name: "my-custom-pulse-config"
      additionalVolumes:
        - name: pulse-config
          type: secret
          path: /some/other/pulse/config/path
    template: hivemq-custom-resource.yml
    asserts:
      - failedTemplate:
          errorMessage: "VolumeMount `pulse-config` (name: `pulse-config` value, mountName: `` value) is duplicated for container `hivemq`"

  - it: should pass validation when additional volume name clashes with default Pulse configuration volume name but in different container
    set:
      pulse:
        name: "my-custom-pulse-config"
      additionalVolumes:
        - name: pulse-config
          type: secret
          containerName: foobar
          path: /some/other/pulse/config/path
    template: hivemq-custom-resource.yml
    asserts:
      - notFailedTemplate: {}
      - hasDocuments:
          count: 1

  - it: should fail validation when both `data` and `overridePulseConfig` are set
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
        overridePulseConfig: |
          <pulse>
            <enabled>true</enabled>
          </pulse>
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate:
          errorMessage: "Both `data` and `overridePulseConfig` values are set for the HiveMQ Pulse configuration content. Please, use only one of them"

  - it: should fail validation when neither `data` nor `overridePulseConfig` are set
    set:
      pulse:
        create: true
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate:
          errorMessage: "HiveMQ Pulse configuration content cannot be empty. Please use either `data` or `overridePulseConfig` values"

  - it: should fail validation when `data` is empty
    set:
      pulse:
        create: true
        data: ""
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate:
          errorMessage: "HiveMQ Pulse configuration content cannot be empty. Please use either `data` or `overridePulseConfig` values"

  - it: should fail validation when `overridePulseConfig` is empty
    set:
      pulse:
        create: true
        overridePulseConfig: ""
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate:
          errorMessage: "HiveMQ Pulse configuration content cannot be empty. Please use either `data` or `overridePulseConfig` values"

  - it: should fail validation when `isPulseConfigBase64Encoded` is true but `data` is not valid base64
    set:
      pulse:
        create: true
        isPulseConfigBase64Encoded: true
        data: "invalid-base64"
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate:
          errorMessage: "HiveMQ Pulse configuration data content is not a Base64 encoded string"

  - it: should fail schema validation when `annotations` is not a map
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
        annotations: "invalid-annotation"
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate: {}

  - it: should fail schema validation when `labels` is not a map
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
        labels: "invalid-label"
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate: {}

  - it: should fail schema validation when `name` is not a string
    set:
      pulse:
        create: true
        name: 123
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate: {}

  - it: should fail schema validation when `create` is not a boolean
    set:
      pulse:
        create: "foobar"
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate: {}

  - it: should fail schema validation when `isPulseConfigBase64Encoded` is not a boolean
    set:
      pulse:
        create: true
        isPulseConfigBase64Encoded: "foobar"
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate: {}

  - it: should fail schema validation when `name` exceeds 253 characters
    set:
      pulse:
        create: true
        name: "this-is-a-very-long-secret-name-that-exceeds-the-maximum-allowed-length-of-253-characters-for-kubernetes-secret-names-and-should-cause-schema-validation-to-fail-because-it-is-way-too-long-and-violates-the-dns-subdomain-naming-conventions-that-kubernetes-enforces-for-secret-resource-names-in-the-cluster"
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
    template: hivemq-pulse-configuration.yml
    asserts:
      - failedTemplate: {}

  - it: should add Pulse Secret to monitoredResources when pulse.create is true
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
    template: hivemq-custom-resource.yml
    asserts:
      - lengthEqual:
          path: spec.monitoredResources
          count: 1
      - equal:
          path: spec.monitoredResources[0].name
          value: hivemq-pulse-configuration-test-platform
      - equal:
          path: spec.monitoredResources[0].type
          value: SECRET
      - equal:
          path: spec.monitoredResources[0].files[0]
          value: config.xml

  - it: should add Pulse Secret with custom name to monitoredResources
    set:
      pulse:
        create: true
        name: my-pulse-config
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
    template: hivemq-custom-resource.yml
    asserts:
      - lengthEqual:
          path: spec.monitoredResources
          count: 1
      - equal:
          path: spec.monitoredResources[0].name
          value: my-pulse-config
      - equal:
          path: spec.monitoredResources[0].type
          value: SECRET
      - equal:
          path: spec.monitoredResources[0].files[0]
          value: config.xml

  - it: should add existing Pulse Secret to monitoredResources when pulse.name is set without create
    set:
      pulse:
        name: existing-pulse-secret
    template: hivemq-custom-resource.yml
    asserts:
      - lengthEqual:
          path: spec.monitoredResources
          count: 1
      - equal:
          path: spec.monitoredResources[0].name
          value: existing-pulse-secret
      - equal:
          path: spec.monitoredResources[0].type
          value: SECRET

  - it: should combine Pulse auto-monitoring with user-defined resources
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
      monitoredResources:
        - name: ese-file-realm
          type: ConfigMap
        - name: custom-credentials
          type: Secret
    template: hivemq-custom-resource.yml
    asserts:
      - lengthEqual:
          path: spec.monitoredResources
          count: 3
      - equal:
          path: spec.monitoredResources[0].name
          value: hivemq-pulse-configuration-test-platform
      - equal:
          path: spec.monitoredResources[0].type
          value: SECRET
      - equal:
          path: spec.monitoredResources[0].files[0]
          value: config.xml
      - equal:
          path: spec.monitoredResources[1].name
          value: ese-file-realm
      - equal:
          path: spec.monitoredResources[1].type
          value: CONFIG_MAP
      - equal:
          path: spec.monitoredResources[2].name
          value: custom-credentials
      - equal:
          path: spec.monitoredResources[2].type
          value: SECRET

  - it: should not add monitoredResources field when pulse is not configured
    asserts:
      - notExists:
          path: spec.monitoredResources
        template: hivemq-custom-resource.yml

  - it: should fail validation when user manually adds Pulse Secret to monitoredResources
    set:
      pulse:
        create: true
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
      monitoredResources:
        - name: hivemq-pulse-configuration-test-platform
          type: Secret
    template: hivemq-custom-resource.yml
    asserts:
      - failedTemplate:
          errorMessage: "The Pulse configuration Secret 'hivemq-pulse-configuration-test-platform' is automatically monitored when Pulse is enabled. Please remove it from `monitoredResources`"

  - it: should fail validation when user manually adds custom Pulse Secret to monitoredResources
    set:
      pulse:
        create: true
        name: my-custom-pulse
        data: "PHB1bHNlPjwvcHVsc2U+" # <pulse></pulse>
      monitoredResources:
        - name: my-custom-pulse
          type: Secret
    template: hivemq-custom-resource.yml
    asserts:
      - failedTemplate:
          errorMessage: "The Pulse configuration Secret 'my-custom-pulse' is automatically monitored when Pulse is enabled. Please remove it from `monitoredResources`"

  - it: should add Pulse Secret to monitoredResources when using overridePulseConfig
    set:
      pulse:
        create: true
        isPulseConfigBase64Encoded: false
        overridePulseConfig: |
          <pulse>
            <enabled>true</enabled>
          </pulse>
    template: hivemq-custom-resource.yml
    asserts:
      - lengthEqual:
          path: spec.monitoredResources
          count: 1
      - equal:
          path: spec.monitoredResources[0].name
          value: hivemq-pulse-configuration-test-platform
      - equal:
          path: spec.monitoredResources[0].type
          value: SECRET
      - equal:
          path: spec.monitoredResources[0].files[0]
          value: config.xml
