#file: noinspection UndefinedAction,UndefinedParamsPresent
name: HiveMQ Legacy Operator Helm Chart Smoke Test
on:
  workflow_call:
env:
  RELEASE_NAME: "smoke-test-release"
jobs:
  run-smoke-test:
    name: Smoke test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout HiveMQ Helm Charts
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          path: helm-charts
          fetch-depth: 0

      - name: Checkout HiveMQ Legacy Operator
        uses: ./helm-charts/.github/actions/checkout-repo
        with:
          repository: hivemq/hivemq-operator
          repository-default-branch: master
          path: hivemq-operator
          token: ${{ secrets.JENKINS_GITHUB_TOKEN }}

      - name: Set up Docker QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3

      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5
        with:
          gradle-home-cache-includes: |
            caches
            notifications
            jdks

      - name: Build HiveMQ Legacy Operator images
        working-directory: helm-charts
        run: ./gradlew :tests-hivemq-operator:build :tests-hivemq-operator:saveDockerImages

      - name: Create K8s Kind Cluster
        uses: helm/kind-action@a1b0e391336a6ee6713a0583f8c6240d70863de3 # v1
        with:
          cluster_name: "kind"

      - name: Load local images into KinD cluster
        working-directory: helm-charts
        run: |
          kind load image-archive ./tests-hivemq-operator/build/hivemq-dns-init-wait.tar
          kind load image-archive ./tests-hivemq-operator/build/hivemq-k8s.tar
          kind load image-archive ./tests-hivemq-operator/build/hivemq-operator.tar

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4

      - name: Install HiveMQ Legacy Operator
        working-directory: helm-charts
        run: |
          helm repo add prometheus https://prometheus-community.github.io/helm-charts
          helm dependency build ./charts/hivemq-operator
          helm install $RELEASE_NAME ./charts/hivemq-operator -f ./examples/hivemq-operator/localStatefulTest.yml --wait --timeout 5m0s --create-namespace -n test

      - name: Wait for pods to be ready
        working-directory: helm-charts
        run: bash ./scripts/wait-for-pods.sh hivemq-cluster hivemq-cluster=$RELEASE_NAME test

      - name: Test HiveMQ Cluster
        run: helm test $RELEASE_NAME --logs -n test

      - name: Capture HiveMQ Legacy Operator Pod logs
        if: always()
        run: |
          mkdir ${{ runner.temp }}/logs
          echo "=== POD STATUS ===" > ${{ runner.temp }}/logs/legacy-pods.log
          kubectl get pods -n test >> ${{ runner.temp }}/logs/legacy-pods.log
          echo "=== CLUSTER LOGS ===" >> ${{ runner.temp }}/logs/legacy-pods.log
          kubectl logs -l hivemq-cluster=$RELEASE_NAME --tail -1 -n test >> ${{ runner.temp }}/logs/legacy-pods.log 2>&1 || echo "Failed to retrieve cluster pods logs" >> ${{ runner.temp }}/logs/legacy-pods.log
          echo "=== LEGACY OPERATOR LOGS ===" >> ${{ runner.temp }}/logs/legacy-pods.log
          kubectl logs -l app=hivemq-operator --tail -1 -n test >> ${{ runner.temp }}/logs/legacy-pods.log 2>&1 || echo "Failed to retrieve legacy operator pod logs" >> ${{ runner.temp }}/logs/legacy-pods.log          

      - name: Upload HiveMQ Legacy Operator Pod logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: smoke-test-legacy-pod-logs
          path: ${{ runner.temp }}/logs/legacy-pods.log
          retention-days: 5

      - name: Print HiveMQ Legacy Operator Pod logs
        if: always()
        run: |
          cat ${{ runner.temp }}/logs/legacy-pods.log

      - name: Uninstall HiveMQ Legacy Operator
        if: always()
        run: |
          helm uninstall $RELEASE_NAME --wait --ignore-not-found -n test
          kubectl get pods -A
