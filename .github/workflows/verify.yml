name: Verify
on:
  push:
    branches:
      - "**"
  workflow_dispatch:
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
      - uses: azure/setup-helm@5119fcb9089d432beecbf79bb2c7915207344b78 # v3
        with:
          # only needed if the version is 'latest'
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Lint
        run: |
          helm lint ./charts/hivemq-platform
          helm lint ./charts/hivemq-platform-operator
          helm lint ./charts/hivemq-operator
          helm lint ./charts/hivemq-swarm
      - name: Unit Test
        uses: d3adb5/helm-unittest-action@82e7919c19e872d2b73811bf00c31126d3f9d256 # v2.3
        with:
          helm-version: v3.10.1
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Check manifests are up-to-date
        run: |
          ./manifests/hivemq-operator/manifests.sh
          ./manifests/hivemq-platform-operator/manifests.sh
          ./manifests/hivemq-platform/manifests.sh
          ./manifests/hivemq-swarm/manifests.sh
          git diff HEAD --exit-code
